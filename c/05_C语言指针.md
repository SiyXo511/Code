# C语言指针

本教程将深入学习C语言中的指针，这是C语言最重要的特性之一。

## 1. 指针基础

### 什么是指针

指针是存储变量地址的变量。

```c
#include <stdio.h>

int main() {
    int x = 10;
    int *ptr;  // 声明指针变量
    
    ptr = &x;  // ptr存储x的地址
    
    printf("x的值: %d\n", x);
    printf("x的地址: %p\n", &x);
    printf("ptr的值（即x的地址）: %p\n", ptr);
    printf("ptr指向的值: %d\n", *ptr);  // 解引用
    
    return 0;
}
```

### 指针操作符

- `&` - 取地址运算符
- `*` - 解引用运算符（间接访问）

```c
#include <stdio.h>

int main() {
    int x = 10;
    int *ptr = &x;
    
    printf("x = %d\n", x);
    printf("&x = %p\n", &x);
    printf("ptr = %p\n", ptr);
    printf("*ptr = %d\n", *ptr);
    
    // 通过指针修改变量的值
    *ptr = 20;
    printf("修改后 x = %d\n", x);
    
    return 0;
}
```

## 2. 指针和数组

### 指针与一维数组

```c
#include <stdio.h>

int main() {
    int arr[] = {10, 20, 30, 40, 50};
    int *ptr = arr;  // 数组名就是首地址
    
    // 通过指针访问数组元素
    printf("通过指针访问数组:\n");
    for (int i = 0; i < 5; i++) {
        printf("arr[%d] = %d\n", i, *(ptr + i));
        // 等价于 arr[i]
    }
    
    // 指针算术运算
    printf("\n指针算术运算:\n");
    printf("*ptr = %d\n", *ptr);
    printf("*(ptr + 1) = %d\n", *(ptr + 1));
    printf("*(ptr + 2) = %d\n", *(ptr + 2));
    
    return 0;
}
```

### 指针数组

```c
#include <stdio.h>

int main() {
    int a = 10, b = 20, c = 30;
    int *arr[3];  // 指针数组
    
    arr[0] = &a;
    arr[1] = &b;
    arr[2] = &c;
    
    printf("通过指针数组访问:\n");
    for (int i = 0; i < 3; i++) {
        printf("arr[%d] = %d\n", i, *arr[i]);
    }
    
    return 0;
}
```

## 3. 指针作为函数参数

### 值传递 vs 地址传递

```c
#include <stdio.h>

// 值传递（不能修改原变量）
void swap_by_value(int a, int b) {
    int temp = a;
    a = b;
    b = temp;
    printf("函数内部: a = %d, b = %d\n", a, b);
}

// 地址传递（可以修改原变量）
void swap_by_reference(int *a, int *b) {
    int temp = *a;
    *a = *b;
    *b = temp;
}

int main() {
    int x = 10, y = 20;
    
    printf("交换前: x = %d, y = %d\n", x, y);
    
    swap_by_value(x, y);
    printf("值传递后: x = %d, y = %d\n", x, y);
    
    swap_by_reference(&x, &y);
    printf("地址传递后: x = %d, y = %d\n", x, y);
    
    return 0;
}
```

### 数组作为函数参数

```c
#include <stdio.h>

// 通过指针传递数组
void modify_array(int *arr, int size) {
    for (int i = 0; i < size; i++) {
        arr[i] *= 2;  // 修改数组元素
    }
}

void print_array(int arr[], int size) {
    for (int i = 0; i < size; i++) {
        printf("%d ", arr[i]);
    }
    printf("\n");
}

int main() {
    int numbers[] = {1, 2, 3, 4, 5};
    int size = 5;
    
    printf("原数组: ");
    print_array(numbers, size);
    
    modify_array(numbers, size);
    
    printf("修改后: ");
    print_array(numbers, size);
    
    return 0;
}
```

## 4. 指针和字符串

```c
#include <stdio.h>
#include <string.h>

int main() {
    char str[] = "Hello";
    char *ptr = str;
    
    // 通过指针访问字符串
    printf("字符串: %s\n", str);
    printf("通过指针: %s\n", ptr);
    
    // 遍历字符串
    printf("逐个字符: ");
    while (*ptr != '\0') {
        printf("%c ", *ptr);
        ptr++;
    }
    printf("\n");
    
    return 0;
}
```

## 5. 指针的指针（二级指针）

```c
#include <stdio.h>

int main() {
    int x = 10;
    int *ptr1 = &x;      // 一级指针
    int **ptr2 = &ptr1;  // 二级指针（指向指针的指针）
    
    printf("x = %d\n", x);
    printf("*ptr1 = %d\n", *ptr1);
    printf("**ptr2 = %d\n", **ptr2);
    
    // 通过二级指针修改值
    **ptr2 = 20;
    printf("修改后 x = %d\n", x);
    
    return 0;
}
```

## 6. 函数指针

```c
#include <stdio.h>

int add(int a, int b) {
    return a + b;
}

int multiply(int a, int b) {
    return a * b;
}

int main() {
    // 声明函数指针
    int (*operation)(int, int);
    
    // 指向add函数
    operation = add;
    printf("add(5, 3) = %d\n", operation(5, 3));
    
    // 指向multiply函数
    operation = multiply;
    printf("multiply(5, 3) = %d\n", operation(5, 3));
    
    return 0;
}
```

### 函数指针数组

```c
#include <stdio.h>

int add(int a, int b) { return a + b; }
int subtract(int a, int b) { return a - b; }
int multiply(int a, int b) { return a * b; }
int divide(int a, int b) { return (b != 0) ? a / b : 0; }

int main() {
    // 函数指针数组
    int (*operations[])(int, int) = {add, subtract, multiply, divide};
    char *names[] = {"加法", "减法", "乘法", "除法"};
    
    int a = 10, b = 5;
    
    for (int i = 0; i < 4; i++) {
        printf("%s: %d %s %d = %d\n", 
               names[i], a, 
               (i == 0) ? "+" : (i == 1) ? "-" : (i == 2) ? "*" : "/",
               b, operations[i](a, b));
    }
    
    return 0;
}
```

## 7. 动态内存分配

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int n;
    int *arr;
    
    printf("请输入数组大小: ");
    scanf("%d", &n);
    
    // 动态分配内存
    arr = (int *)malloc(n * sizeof(int));
    
    if (arr == NULL) {
        printf("内存分配失败\n");
        return 1;
    }
    
    // 输入数组元素
    printf("请输入%d个整数:\n", n);
    for (int i = 0; i < n; i++) {
        scanf("%d", &arr[i]);
    }
    
    // 输出数组元素
    printf("数组元素: ");
    for (int i = 0; i < n; i++) {
        printf("%d ", arr[i]);
    }
    printf("\n");
    
    // 释放内存
    free(arr);
    
    return 0;
}
```

### calloc 和 realloc

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int *arr1, *arr2;
    int n = 5;
    
    // calloc: 分配并初始化为0
    arr1 = (int *)calloc(n, sizeof(int));
    printf("calloc分配的内存（初始化为0）:\n");
    for (int i = 0; i < n; i++) {
        printf("%d ", arr1[i]);
    }
    printf("\n");
    
    // 重新分配内存大小
    arr2 = (int *)realloc(arr1, 10 * sizeof(int));
    if (arr2 != NULL) {
        arr1 = arr2;
        printf("重新分配后的大小: 10\n");
    }
    
    free(arr1);
    
    return 0;
}
```

## 8. 指针的常见错误

```c
#include <stdio.h>

int main() {
    // 错误1: 未初始化的指针
    // int *ptr;
    // *ptr = 10;  // 危险！指针未初始化
    
    // 错误2: 野指针（指向已释放的内存）
    int *ptr1 = (int *)malloc(sizeof(int));
    free(ptr1);
    // *ptr1 = 10;  // 危险！ptr1已成为野指针
    ptr1 = NULL;  // 应该置为NULL
    
    // 错误3: 数组越界
    int arr[5];
    int *ptr2 = arr;
    // ptr2[10] = 100;  // 危险！数组越界
    
    // 正确做法
    int x = 10;
    int *ptr3 = &x;
    *ptr3 = 20;  // 正确
    
    printf("x = %d\n", x);
    
    return 0;
}
```

## 9. 综合示例

### 示例1：使用指针实现字符串处理

```c
#include <stdio.h>
#include <string.h>

void reverse_string(char *str) {
    int len = strlen(str);
    char *start = str;
    char *end = str + len - 1;
    
    while (start < end) {
        char temp = *start;
        *start = *end;
        *end = temp;
        start++;
        end--;
    }
}

int main() {
    char str[100];
    printf("请输入字符串: ");
    scanf("%s", str);
    
    printf("原字符串: %s\n", str);
    reverse_string(str);
    printf("反转后: %s\n", str);
    
    return 0;
}
```

### 示例2：指针实现链表节点

```c
#include <stdio.h>
#include <stdlib.h>

// 链表节点结构
struct Node {
    int data;
    struct Node *next;
};

int main() {
    // 创建节点
    struct Node *head = NULL;
    
    // 分配内存
    head = (struct Node *)malloc(sizeof(struct Node));
    head->data = 10;
    head->next = NULL;
    
    printf("节点数据: %d\n", head->data);
    
    // 释放内存
    free(head);
    
    return 0;
}
```

## 练习

1. 编写函数，使用指针实现数组元素的逆序
2. 编写函数，使用指针统计字符串中某个字符出现的次数
3. 使用动态内存分配，实现一个可变大小的数组
4. 编写程序，使用函数指针实现一个简单的计算器

