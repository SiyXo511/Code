# C语言文件操作

本教程将学习C语言中的文件操作，包括文件的打开、读取、写入和关闭。

## 1. 文件操作基础

### 文件指针

```c
#include <stdio.h>

int main() {
    FILE *file;  // 文件指针
    
    // 打开文件
    file = fopen("example.txt", "w");
    
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    // 写入数据
    fprintf(file, "Hello, World!\n");
    fprintf(file, "这是第二行\n");
    
    // 关闭文件
    fclose(file);
    printf("文件写入成功\n");
    
    return 0;
}
```

### 文件打开模式

- `"r"` - 只读（文件必须存在）
- `"w"` - 只写（如果文件存在则清空，不存在则创建）
- `"a"` - 追加（在文件末尾添加）
- `"r+"` - 读写（文件必须存在）
- `"w+"` - 读写（如果文件存在则清空，不存在则创建）
- `"a+"` - 读写追加

## 2. 文件写入

### fprintf 和 fputs

```c
#include <stdio.h>

int main() {
    FILE *file = fopen("output.txt", "w");
    
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    // fprintf: 格式化写入
    int age = 25;
    char name[] = "张三";
    float score = 85.5f;
    
    fprintf(file, "姓名: %s\n", name);
    fprintf(file, "年龄: %d\n", age);
    fprintf(file, "成绩: %.2f\n", score);
    
    // fputs: 写入字符串
    fputs("这是一行文本\n", file);
    fputs("这是另一行文本\n", file);
    
    // fputc: 写入单个字符
    fputc('A', file);
    fputc('\n', file);
    
    fclose(file);
    printf("文件写入完成\n");
    
    return 0;
}
```

### fwrite 二进制写入

```c
#include <stdio.h>

int main() {
    FILE *file = fopen("data.bin", "wb");  // 二进制模式
    
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    int numbers[] = {10, 20, 30, 40, 50};
    int count = 5;
    
    // fwrite: 二进制写入
    fwrite(numbers, sizeof(int), count, file);
    
    fclose(file);
    printf("二进制文件写入完成\n");
    
    return 0;
}
```

## 3. 文件读取

### fscanf 和 fgets

```c
#include <stdio.h>

int main() {
    FILE *file = fopen("input.txt", "r");
    
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    char name[50];
    int age;
    float score;
    
    // fscanf: 格式化读取
    fscanf(file, "姓名: %s\n", name);
    fscanf(file, "年龄: %d\n", &age);
    fscanf(file, "成绩: %f\n", &score);
    
    printf("读取的数据:\n");
    printf("姓名: %s\n", name);
    printf("年龄: %d\n", age);
    printf("成绩: %.2f\n", score);
    
    // fgets: 读取一行
    char line[100];
    while (fgets(line, sizeof(line), file) != NULL) {
        printf("行: %s", line);
    }
    
    fclose(file);
    
    return 0;
}
```

### fread 二进制读取

```c
#include <stdio.h>

int main() {
    FILE *file = fopen("data.bin", "rb");  // 二进制模式
    
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    int numbers[5];
    
    // fread: 二进制读取
    fread(numbers, sizeof(int), 5, file);
    
    printf("读取的数据:\n");
    for (int i = 0; i < 5; i++) {
        printf("%d ", numbers[i]);
    }
    printf("\n");
    
    fclose(file);
    
    return 0;
}
```

### fgetc 逐个字符读取

```c
#include <stdio.h>

int main() {
    FILE *file = fopen("example.txt", "r");
    
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    int ch;
    printf("文件内容:\n");
    while ((ch = fgetc(file)) != EOF) {  // EOF: End of File
        putchar(ch);
    }
    
    fclose(file);
    
    return 0;
}
```

## 4. 文件位置操作

### ftell, fseek, rewind

```c
#include <stdio.h>

int main() {
    FILE *file = fopen("example.txt", "r+");
    
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    // ftell: 获取当前位置
    long position = ftell(file);
    printf("当前位置: %ld\n", position);
    
    // fseek: 移动文件指针
    fseek(file, 0, SEEK_END);  // 移动到文件末尾
    position = ftell(file);
    printf("文件大小: %ld 字节\n", position);
    
    fseek(file, 0, SEEK_SET);  // 移动到文件开头
    // 或者使用 rewind(file);
    
    fseek(file, 10, SEEK_CUR);  // 从当前位置向后移动10字节
    
    fclose(file);
    
    return 0;
}
```

**fseek参数：**
- `SEEK_SET` - 文件开头
- `SEEK_CUR` - 当前位置
- `SEEK_END` - 文件末尾

## 5. 错误检测

### feof 和 ferror

```c
#include <stdio.h>

int main() {
    FILE *file = fopen("example.txt", "r");
    
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    int ch;
    while ((ch = fgetc(file)) != EOF) {
        putchar(ch);
    }
    
    // 检查是否到达文件末尾
    if (feof(file)) {
        printf("\n已到达文件末尾\n");
    }
    
    // 检查文件操作是否出错
    if (ferror(file)) {
        printf("文件读取出错\n");
    }
    
    // 清除错误标志
    clearerr(file);
    
    fclose(file);
    
    return 0;
}
```

## 6. 综合示例

### 示例1：文件复制

```c
#include <stdio.h>

int copy_file(const char *source, const char *dest) {
    FILE *src_file = fopen(source, "rb");
    FILE *dest_file = fopen(dest, "wb");
    
    if (src_file == NULL || dest_file == NULL) {
        if (src_file != NULL) fclose(src_file);
        if (dest_file != NULL) fclose(dest_file);
        return 1;
    }
    
    int ch;
    while ((ch = fgetc(src_file)) != EOF) {
        fputc(ch, dest_file);
    }
    
    fclose(src_file);
    fclose(dest_file);
    
    return 0;
}

int main() {
    if (copy_file("source.txt", "dest.txt") == 0) {
        printf("文件复制成功\n");
    } else {
        printf("文件复制失败\n");
    }
    
    return 0;
}
```

### 示例2：学生信息文件管理

```c
#include <stdio.h>
#include <string.h>

typedef struct {
    int id;
    char name[50];
    int age;
    float score;
} Student;

void save_student(FILE *file, Student *s) {
    fprintf(file, "%d %s %d %.2f\n", s->id, s->name, s->age, s->score);
}

int load_student(FILE *file, Student *s) {
    return fscanf(file, "%d %s %d %f\n", 
                  &s->id, s->name, &s->age, &s->score) == 4;
}

int main() {
    // 写入学生信息
    FILE *file = fopen("students.txt", "w");
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    Student students[] = {
        {1, "张三", 20, 85.5f},
        {2, "李四", 21, 90.0f},
        {3, "王五", 20, 78.5f}
    };
    
    for (int i = 0; i < 3; i++) {
        save_student(file, &students[i]);
    }
    fclose(file);
    printf("学生信息已保存\n");
    
    // 读取学生信息
    file = fopen("students.txt", "r");
    if (file == NULL) {
        printf("文件打开失败\n");
        return 1;
    }
    
    Student s;
    printf("\n读取的学生信息:\n");
    while (load_student(file, &s)) {
        printf("学号: %d, 姓名: %s, 年龄: %d, 成绩: %.2f\n",
               s.id, s.name, s.age, s.score);
    }
    fclose(file);
    
    return 0;
}
```

### 示例3：统计文件信息

```c
#include <stdio.h>

void analyze_file(const char *filename) {
    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("文件打开失败\n");
        return;
    }
    
    int chars = 0, lines = 0, words = 0;
    int in_word = 0;
    int ch;
    
    while ((ch = fgetc(file)) != EOF) {
        chars++;
        
        if (ch == '\n') {
            lines++;
        }
        
        if (ch == ' ' || ch == '\t' || ch == '\n') {
            if (in_word) {
                words++;
                in_word = 0;
            }
        } else {
            in_word = 1;
        }
    }
    
    if (in_word) {
        words++;
    }
    
    fclose(file);
    
    printf("文件统计信息:\n");
    printf("字符数: %d\n", chars);
    printf("行数: %d\n", lines);
    printf("单词数: %d\n", words);
}

int main() {
    analyze_file("example.txt");
    return 0;
}
```

## 7. 临时文件

```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    FILE *temp_file;
    char temp_filename[L_tmpnam];
    
    // 创建临时文件名
    tmpnam(temp_filename);
    printf("临时文件名: %s\n", temp_filename);
    
    // 打开临时文件
    temp_file = fopen(temp_filename, "w+");
    if (temp_file != NULL) {
        fprintf(temp_file, "这是临时文件内容\n");
        fclose(temp_file);
        
        // 删除临时文件
        remove(temp_filename);
        printf("临时文件已删除\n");
    }
    
    return 0;
}
```

## 练习

1. 编写程序，实现文件的逐行复制（保持原格式）
2. 编写程序，读取一个文件，统计每个字符出现的次数
3. 编写程序，实现文件的合并（将两个文件合并成一个）
4. 编写程序，实现简单的文本编辑器（读取、显示、保存功能）

