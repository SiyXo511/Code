# C语言多文件编程和头文件管理

本教程将学习C语言中的多文件编程，包括头文件管理、模块化设计等内容。

## 1. 多文件编程基础

### 项目结构示例

```
project/
├── main.c          # 主程序
├── math_utils.c    # 数学工具实现
├── math_utils.h    # 数学工具声明
├── string_utils.c  # 字符串工具实现
├── string_utils.h  # 字符串工具声明
└── Makefile        # 编译脚本
```

### 头文件（.h）

```c
// math_utils.h
#ifndef MATH_UTILS_H
#define MATH_UTILS_H

// 函数声明
int add(int a, int b);
int subtract(int a, int b);
int multiply(int a, int b);
double divide(double a, double b);

// 常量定义
#define PI 3.14159
#define E 2.71828

// 类型定义
typedef struct {
    double x;
    double y;
} Point;

// 宏定义
#define MAX(a, b) ((a) > (b) ? (a) : (b))
#define MIN(a, b) ((a) < (b) ? (a) : (b))

#endif // MATH_UTILS_H
```

### 源文件（.c）

```c
// math_utils.c
#include "math_utils.h"

// 函数实现
int add(int a, int b) {
    return a + b;
}

int subtract(int a, int b) {
    return a - b;
}

int multiply(int a, int b) {
    return a * b;
}

double divide(double a, double b) {
    if (b != 0.0) {
        return a / b;
    }
    return 0.0;
}
```

### 主程序

```c
// main.c
#include <stdio.h>
#include "math_utils.h"

int main() {
    printf("10 + 5 = %d\n", add(10, 5));
    printf("10 - 5 = %d\n", subtract(10, 5));
    printf("10 * 5 = %d\n", multiply(10, 5));
    printf("10.0 / 3.0 = %.2f\n", divide(10.0, 3.0));
    
    printf("PI = %.5f\n", PI);
    
    return 0;
}
```

## 2. 头文件保护

### 防止重复包含

```c
// myheader.h
#ifndef MYHEADER_H
#define MYHEADER_H

// 头文件内容

#endif // MYHEADER_H
```

### #pragma once（非标准但广泛支持）

```c
// another_header.h
#pragma once

// 头文件内容
```

## 3. 前向声明

```c
// header.h
#ifndef HEADER_H
#define HEADER_H

// 前向声明，避免包含完整的头文件
struct SomeStruct;
typedef struct SomeStruct SomeStruct;

// 使用前向声明的指针或引用
void process_struct(SomeStruct *ptr);

#endif // HEADER_H

// implementation.c
#include "header.h"

// 完整定义
struct SomeStruct {
    int data;
    char name[50];
};

void process_struct(SomeStruct *ptr) {
    // 实现
}
```

## 4. 静态函数和变量

### 静态函数（内部链接）

```c
// utils.c
#include "utils.h"

// 静态函数：只在当前文件内可见
static void internal_helper() {
    // 辅助函数实现
}

// 公共函数
void public_function() {
    internal_helper();  // 可以使用内部函数
    // 实现
}

// 其他文件无法调用internal_helper
```

### 静态变量

```c
// counter.c
#include "counter.h"

// 静态全局变量：只在当前文件内可见
static int count = 0;

// 访问计数器的函数
int get_count() {
    return count;
}

void increment_count() {
    count++;
}

void reset_count() {
    count = 0;
}
```

## 5. extern 关键字

### 跨文件共享变量

```c
// globals.h
#ifndef GLOBALS_H
#define GLOBALS_H

// 声明全局变量（extern表示在其他文件中定义）
extern int global_counter;
extern const char *global_name;

#endif // GLOBALS_H

// globals.c
#include "globals.h"

// 定义全局变量
int global_counter = 0;
const char *global_name = "MyApp";

// main.c
#include <stdio.h>
#include "globals.h"

int main() {
    printf("Counter: %d\n", global_counter);
    printf("Name: %s\n", global_name);
    
    global_counter++;
    printf("After increment: %d\n", global_counter);
    
    return 0;
}
```

## 6. Makefile 构建

### 简单的 Makefile

```makefile
# Makefile
CC = gcc
CFLAGS = -Wall -g
TARGET = myprogram
SOURCES = main.c math_utils.c string_utils.c
OBJECTS = $(SOURCES:.c=.o)

# 默认目标
all: $(TARGET)

# 链接目标文件生成可执行文件
$(TARGET): $(OBJECTS)
	$(CC) $(CFLAGS) -o $(TARGET) $(OBJECTS)

# 编译源文件生成目标文件
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# 清理生成的文件
clean:
	rm -f $(OBJECTS) $(TARGET)

# 声明伪目标
.PHONY: all clean
```

### 使用 Makefile

```bash
# 编译
make

# 清理
make clean

# 强制重新编译
make clean && make
```

## 7. 条件编译

### 根据平台编译

```c
// config.h
#ifndef CONFIG_H
#define CONFIG_H

#ifdef _WIN32
    #define OS_WINDOWS 1
    #define PATH_SEPARATOR "\\"
#elif defined(__linux__)
    #define OS_LINUX 1
    #define PATH_SEPARATOR "/"
#elif defined(__APPLE__)
    #define OS_MACOS 1
    #define PATH_SEPARATOR "/"
#endif

#ifdef DEBUG
    #define LOG(msg) printf("[DEBUG] %s\n", msg)
#else
    #define LOG(msg) ((void)0)
#endif

#endif // CONFIG_H
```

## 8. 模块化设计示例

### 完整的项目示例

```c
// student.h
#ifndef STUDENT_H
#define STUDENT_H

typedef struct {
    int id;
    char name[50];
    int age;
    float score;
} Student;

// 函数声明
Student* student_create(int id, const char *name, int age, float score);
void student_destroy(Student *s);
void student_print(const Student *s);
void student_update_score(Student *s, float new_score);

#endif // STUDENT_H

// student.c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "student.h"

Student* student_create(int id, const char *name, int age, float score) {
    Student *s = (Student *)malloc(sizeof(Student));
    if (s == NULL) {
        return NULL;
    }
    
    s->id = id;
    strncpy(s->name, name, sizeof(s->name) - 1);
    s->name[sizeof(s->name) - 1] = '\0';
    s->age = age;
    s->score = score;
    
    return s;
}

void student_destroy(Student *s) {
    if (s != NULL) {
        free(s);
    }
}

void student_print(const Student *s) {
    if (s != NULL) {
        printf("学号: %d, 姓名: %s, 年龄: %d, 成绩: %.2f\n",
               s->id, s->name, s->age, s->score);
    }
}

void student_update_score(Student *s, float new_score) {
    if (s != NULL) {
        s->score = new_score;
    }
}

// main.c
#include <stdio.h>
#include "student.h"

int main() {
    Student *s1 = student_create(1, "张三", 20, 85.5f);
    Student *s2 = student_create(2, "李四", 21, 90.0f);
    
    student_print(s1);
    student_print(s2);
    
    student_update_score(s1, 95.0f);
    student_print(s1);
    
    student_destroy(s1);
    student_destroy(s2);
    
    return 0;
}
```

## 9. 库文件

### 静态库（.a）

```makefile
# 创建静态库
libmath.a: math_utils.o
	ar rcs libmath.a math_utils.o

# 使用静态库
program: main.o libmath.a
	gcc -o program main.o -L. -lmath
```

### 动态库（.so / .dll）

```makefile
# 创建动态库（Linux）
libmath.so: math_utils.o
	gcc -shared -o libmath.so math_utils.o

# 使用动态库
program: main.o
	gcc -o program main.o -L. -lmath

# 设置库路径（运行时）
export LD_LIBRARY_PATH=.:$LD_LIBRARY_PATH
```

## 10. 头文件组织技巧

### 依赖关系管理

```c
// 原则：只包含需要的头文件
// 使用前向声明减少依赖

// 好的做法
struct Node;  // 前向声明
void process_node(struct Node *node);  // 只需要指针

// 不好的做法
#include "node.h"  // 如果只需要指针，不需要完整定义
```

### 包含顺序

```c
// 推荐的包含顺序：
// 1. 对应的头文件（如果存在）
#include "myfile.h"

// 2. C标准库头文件
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// 3. 系统头文件
#include <sys/types.h>

// 4. 第三方库头文件
#include <json.h>

// 5. 项目其他头文件
#include "utils.h"
#include "config.h"
```

## 练习

1. 创建一个包含多个模块的项目（如：文件管理、数据处理、用户界面）
2. 编写 Makefile 管理多文件项目
3. 创建并使用静态库
4. 实现一个模块化的学生管理系统

