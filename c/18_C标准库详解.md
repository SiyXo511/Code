# C标准库详解

本教程将深入学习C语言标准库，包括常用函数库的详细使用方法。

## 1. stdio.h - 标准输入输出

### 文件操作高级用法

```c
#include <stdio.h>
#include <stdlib.h>

// 格式化字符串
void string_formatting() {
    char buffer[256];
    
    // sprintf: 格式化字符串
    int age = 25;
    char name[] = "张三";
    sprintf(buffer, "姓名: %s, 年龄: %d", name, age);
    printf("%s\n", buffer);
    
    // snprintf: 安全的格式化（防止溢出）
    snprintf(buffer, sizeof(buffer), "姓名: %s, 年龄: %d", name, age);
    printf("%s\n", buffer);
    
    // sscanf: 从字符串读取
    char data[] = "姓名: 李四, 年龄: 30";
    char name2[50];
    int age2;
    sscanf(data, "姓名: %s, 年龄: %d", name2, &age2);
    printf("解析结果: %s, %d\n", name2, age2);
}

// 文件流操作
void file_stream_ops() {
    FILE *file = fopen("stream_test.txt", "w+");
    if (file == NULL) {
        perror("文件打开失败");
        return;
    }
    
    // 使用ftell获取当前位置
    long pos = ftell(file);
    printf("当前位置: %ld\n", pos);
    
    // 写入数据
    fprintf(file, "Line 1\n");
    fprintf(file, "Line 2\n");
    fprintf(file, "Line 3\n");
    
    // 回到开头
    rewind(file);
    
    // 读取数据
    char line[100];
    while (fgets(line, sizeof(line), file) != NULL) {
        printf("读取: %s", line);
    }
    
    fclose(file);
}
```

## 2. stdlib.h - 标准库函数

### 内存管理函数

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void memory_functions() {
    // calloc: 分配并初始化为0
    int *arr1 = (int *)calloc(10, sizeof(int));
    printf("calloc分配的内存（初始化为0）:\n");
    for (int i = 0; i < 10; i++) {
        printf("%d ", arr1[i]);
    }
    printf("\n");
    free(arr1);
    
    // realloc: 重新分配内存
    int *arr2 = (int *)malloc(5 * sizeof(int));
    for (int i = 0; i < 5; i++) {
        arr2[i] = i;
    }
    
    // 扩展到10个元素
    arr2 = (int *)realloc(arr2, 10 * sizeof(int));
    for (int i = 5; i < 10; i++) {
        arr2[i] = i;
    }
    
    printf("realloc后的数组:\n");
    for (int i = 0; i < 10; i++) {
        printf("%d ", arr2[i]);
    }
    printf("\n");
    free(arr2);
}

// 环境函数
void environment_functions() {
    const char *path = getenv("PATH");
    if (path != NULL) {
        printf("PATH: %s\n", path);
    }
    
    // 设置环境变量（仅当前进程）
    if (setenv("MY_VAR", "my_value", 1) == 0) {
        printf("MY_VAR = %s\n", getenv("MY_VAR"));
    }
    
    // 删除环境变量
    unsetenv("MY_VAR");
}
```

### 字符串转换

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>

void string_conversion() {
    // atoi: 字符串转整数（不检查错误）
    const char *str1 = "12345";
    int num1 = atoi(str1);
    printf("atoi: %s -> %d\n", str1, num1);
    
    // strtol: 字符串转长整数（检查错误）
    const char *str2 = "12345";
    char *endptr;
    long num2 = strtol(str2, &endptr, 10);
    if (*endptr == '\0') {
        printf("strtol: %s -> %ld\n", str2, num2);
    } else {
        printf("strtol错误: 无效字符\n");
    }
    
    // atof: 字符串转浮点数
    const char *str3 = "123.456";
    double num3 = atof(str3);
    printf("atof: %s -> %f\n", str3, num3);
    
    // strtod: 字符串转双精度（检查错误）
    const char *str4 = "123.456";
    char *endptr2;
    double num4 = strtod(str4, &endptr2);
    if (*endptr2 == '\0') {
        printf("strtod: %s -> %f\n", str4, num4);
    }
}
```

## 3. string.h - 字符串操作

### 字符串函数详解

```c
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

void string_functions() {
    char str1[100] = "Hello";
    char str2[100] = "World";
    char str3[100];
    
    // strcpy: 复制字符串
    strcpy(str3, str1);
    printf("strcpy: %s\n", str3);
    
    // strncpy: 安全复制（指定长度）
    char str4[10];
    strncpy(str4, "Hello, World!", sizeof(str4) - 1);
    str4[sizeof(str4) - 1] = '\0';
    printf("strncpy: %s\n", str4);
    
    // strcat: 连接字符串
    strcat(str1, " ");
    strcat(str1, str2);
    printf("strcat: %s\n", str1);
    
    // strncat: 安全连接（指定长度）
    char str5[20] = "Hello";
    strncat(str5, ", World!", sizeof(str5) - strlen(str5) - 1);
    printf("strncat: %s\n", str5);
    
    // strcmp: 比较字符串
    int result = strcmp("Apple", "Banana");
    if (result < 0) {
        printf("Apple < Banana\n");
    } else if (result > 0) {
        printf("Apple > Banana\n");
    } else {
        printf("Apple == Banana\n");
    }
    
    // strncmp: 比较前n个字符
    result = strncmp("Hello", "Help", 3);
    printf("strncmp(\"Hello\", \"Help\", 3) = %d\n", result);
    
    // strlen: 字符串长度
    printf("strlen(\"Hello\") = %lu\n", strlen("Hello"));
    
    // strchr: 查找字符
    const char *str6 = "Hello, World!";
    char *found = strchr(str6, 'o');
    if (found != NULL) {
        printf("找到字符'o'，位置: %ld\n", found - str6);
    }
    
    // strstr: 查找子字符串
    const char *str7 = "Hello, World!";
    char *substr = strstr(str7, "World");
    if (substr != NULL) {
        printf("找到子字符串\"World\"，位置: %ld\n", substr - str7);
    }
    
    // strtok: 分割字符串
    char str8[] = "apple,banana,orange";
    char *token = strtok(str8, ",");
    printf("分割结果:\n");
    while (token != NULL) {
        printf("  %s\n", token);
        token = strtok(NULL, ",");
    }
}
```

### 内存操作函数

```c
#include <stdio.h>
#include <string.h>

void memory_functions() {
    int arr1[5] = {1, 2, 3, 4, 5};
    int arr2[5];
    
    // memcpy: 内存复制
    memcpy(arr2, arr1, sizeof(arr1));
    printf("memcpy后的数组: ");
    for (int i = 0; i < 5; i++) {
        printf("%d ", arr2[i]);
    }
    printf("\n");
    
    // memmove: 内存移动（处理重叠区域）
    int arr3[10] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
    memmove(arr3 + 2, arr3, 5 * sizeof(int));
    printf("memmove后的数组: ");
    for (int i = 0; i < 10; i++) {
        printf("%d ", arr3[i]);
    }
    printf("\n");
    
    // memset: 内存设置
    int arr4[10];
    memset(arr4, 0, sizeof(arr4));
    printf("memset后的数组: ");
    for (int i = 0; i < 10; i++) {
        printf("%d ", arr4[i]);
    }
    printf("\n");
    
    // memcmp: 内存比较
    int arr5[] = {1, 2, 3, 4, 5};
    int arr6[] = {1, 2, 3, 4, 5};
    int result = memcmp(arr5, arr6, sizeof(arr5));
    printf("memcmp结果: %d (0表示相等)\n", result);
}
```

## 4. ctype.h - 字符分类

```c
#include <stdio.h>
#include <ctype.h>

void character_functions() {
    char ch;
    
    printf("字符分类函数:\n");
    
    ch = 'A';
    printf("'%c' 是大写字母: %d\n", ch, isupper(ch));
    printf("'%c' 是小写字母: %d\n", ch, islower(ch));
    printf("'%c' 是字母: %d\n", ch, isalpha(ch));
    printf("'%c' 是数字: %d\n", ch, isdigit(ch));
    printf("'%c' 是字母或数字: %d\n", ch, isalnum(ch));
    printf("'%c' 是空白字符: %d\n", ch, isspace(ch));
    printf("'%c' 是标点符号: %d\n", ch, ispunct(ch));
    
    // 字符转换
    ch = 'A';
    printf("'%c' 转小写: '%c'\n", ch, tolower(ch));
    
    ch = 'a';
    printf("'%c' 转大写: '%c'\n", ch, toupper(ch));
    
    // 实际应用：转换字符串大小写
    char str[] = "Hello, World!";
    printf("原字符串: %s\n", str);
    
    for (int i = 0; str[i] != '\0'; i++) {
        str[i] = tolower(str[i]);
    }
    printf("转小写: %s\n", str);
    
    for (int i = 0; str[i] != '\0'; i++) {
        str[i] = toupper(str[i]);
    }
    printf("转大写: %s\n", str);
}
```

## 5. time.h - 时间函数

```c
#include <stdio.h>
#include <time.h>
#include <string.h>

void time_functions() {
    // 获取当前时间
    time_t rawtime;
    struct tm *timeinfo;
    char buffer[80];
    
    time(&rawtime);
    timeinfo = localtime(&rawtime);
    
    // 格式化时间
    strftime(buffer, sizeof(buffer), "%Y-%m-%d %H:%M:%S", timeinfo);
    printf("当前时间: %s\n", buffer);
    
    // 其他时间格式
    strftime(buffer, sizeof(buffer), "%A, %B %d, %Y", timeinfo);
    printf("完整日期: %s\n", buffer);
    
    strftime(buffer, sizeof(buffer), "%I:%M %p", timeinfo);
    printf("12小时制时间: %s\n", buffer);
    
    // 时间差计算
    time_t start = time(NULL);
    sleep(2);  // 等待2秒
    time_t end = time(NULL);
    double diff = difftime(end, start);
    printf("时间差: %.2f 秒\n", diff);
    
    // 使用clock测量CPU时间
    clock_t cpu_start = clock();
    // 执行一些操作...
    for (volatile int i = 0; i < 1000000; i++);
    clock_t cpu_end = clock();
    double cpu_time = ((double)(cpu_end - cpu_start)) / CLOCKS_PER_SEC;
    printf("CPU时间: %.6f 秒\n", cpu_time);
}
```

## 6. math.h - 数学函数

```c
#include <stdio.h>
#include <math.h>

void math_functions() {
    double x = 2.0;
    double y = 3.0;
    
    // 基本数学函数
    printf("pow(%.2f, %.2f) = %.2f\n", x, y, pow(x, y));
    printf("sqrt(%.2f) = %.2f\n", x, sqrt(x));
    printf("exp(%.2f) = %.2f\n", x, exp(x));
    printf("log(%.2f) = %.2f\n", x, log(x));
    printf("log10(%.2f) = %.2f\n", x, log10(x));
    
    // 三角函数
    double angle = M_PI / 4.0;  // 45度
    printf("sin(%.2f) = %.2f\n", angle, sin(angle));
    printf("cos(%.2f) = %.2f\n", angle, cos(angle));
    printf("tan(%.2f) = %.2f\n", angle, tan(angle));
    
    // 反三角函数
    printf("asin(%.2f) = %.2f\n", sin(angle), asin(sin(angle)));
    printf("acos(%.2f) = %.2f\n", cos(angle), acos(cos(angle)));
    printf("atan(%.2f) = %.2f\n", tan(angle), atan(tan(angle)));
    
    // 双曲函数
    printf("sinh(%.2f) = %.2f\n", x, sinh(x));
    printf("cosh(%.2f) = %.2f\n", x, cosh(x));
    printf("tanh(%.2f) = %.2f\n", x, tanh(x));
    
    // 取整函数
    double value = 3.7;
    printf("floor(%.2f) = %.2f\n", value, floor(value));
    printf("ceil(%.2f) = %.2f\n", value, ceil(value));
    printf("round(%.2f) = %.2f\n", value, round(value));
    printf("trunc(%.2f) = %.2f\n", value, trunc(value));
    
    // 绝对值和符号
    double neg = -5.5;
    printf("fabs(%.2f) = %.2f\n", neg, fabs(neg));
    
    // 余数
    printf("fmod(10.5, 3.0) = %.2f\n", fmod(10.5, 3.0));
}

// 编译时需要链接数学库: gcc program.c -o program -lm
```

## 7. stdarg.h - 可变参数

```c
#include <stdio.h>
#include <stdarg.h>

// 可变参数函数：计算平均值
double average(int count, ...) {
    va_list args;
    va_start(args, count);
    
    double sum = 0.0;
    for (int i = 0; i < count; i++) {
        sum += va_arg(args, double);
    }
    
    va_end(args);
    return sum / count;
}

// 可变参数函数：打印格式化的值
void print_values(const char *format, int count, ...) {
    va_list args;
    va_start(args, count);
    
    for (int i = 0; i < count; i++) {
        if (format[i] == 'i') {
            int value = va_arg(args, int);
            printf("整数: %d\n", value);
        } else if (format[i] == 'd') {
            double value = va_arg(args, double);
            printf("浮点数: %.2f\n", value);
        } else if (format[i] == 's') {
            char *value = va_arg(args, char *);
            printf("字符串: %s\n", value);
        }
    }
    
    va_end(args);
}

int main() {
    // 计算平均值
    double avg = average(5, 10.5, 20.5, 30.5, 40.5, 50.5);
    printf("平均值: %.2f\n", avg);
    
    // 打印不同类型的值
    print_values("ids", 3, 100, 3.14, "Hello");
    
    return 0;
}
```

## 8. 综合示例

### 字符串处理工具函数

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

// 去除字符串首尾空白
char* trim(char *str) {
    // 去除尾部空白
    char *end = str + strlen(str) - 1;
    while (end > str && isspace((unsigned char)*end)) {
        end--;
    }
    end[1] = '\0';
    
    // 去除头部空白
    while (*str && isspace((unsigned char)*str)) {
        str++;
    }
    
    return str;
}

// 字符串分割
char** split_string(const char *str, const char *delim, int *count) {
    char *str_copy = strdup(str);
    char *token;
    char **result = NULL;
    int capacity = 10;
    int size = 0;
    
    result = (char **)malloc(capacity * sizeof(char *));
    
    token = strtok(str_copy, delim);
    while (token != NULL) {
        if (size >= capacity) {
            capacity *= 2;
            result = (char **)realloc(result, capacity * sizeof(char *));
        }
        result[size++] = strdup(token);
        token = strtok(NULL, delim);
    }
    
    *count = size;
    free(str_copy);
    return result;
}

int main() {
    // 测试trim
    char str1[] = "  Hello, World!  ";
    printf("原字符串: '%s'\n", str1);
    printf("处理后: '%s'\n", trim(str1));
    
    // 测试split
    const char *str2 = "apple,banana,orange,grape";
    int count;
    char **tokens = split_string(str2, ",", &count);
    
    printf("\n分割结果（%d个）:\n", count);
    for (int i = 0; i < count; i++) {
        printf("  [%d] %s\n", i, tokens[i]);
        free(tokens[i]);
    }
    free(tokens);
    
    return 0;
}
```

## 练习

1. 实现一个完整的字符串工具库
2. 创建一个日期时间处理库
3. 编写一个通用的日志系统
4. 实现一个配置解析器（读取配置文件）

